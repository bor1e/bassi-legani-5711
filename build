#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INPUT="$SCRIPT_DIR/input/5711/[0-9]*.md"
SCRIPTS="$SCRIPT_DIR/scripts"
TEMPLATES="$SCRIPT_DIR/templates/typst"
OUTPUT="$SCRIPT_DIR/dist"
FONTS="$SCRIPT_DIR/fonts"

usage() {
    echo "Usage: ./build <target> [--version <version>]"
    echo ""
    echo "Targets:"
    echo "  a4      Build PDF (A4 two-column)"
    echo "  a5      Build PDF (A5 single-column)"
    echo "  epub    Build EPUB"
    echo "  all     Build all formats"
    echo ""
    echo "Options:"
    echo "  --version <version>  Version string to inject (e.g. v1.2.3). Omit to hide version."
    exit 1
}

[[ $# -lt 1 ]] && usage

TARGET="$1"
shift

VERSION=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --version) VERSION="$2"; shift 2 ;;
        *) echo "Unknown option: $1"; usage ;;
    esac
done

VERSION_FLAG=""
if [[ -n "$VERSION" ]]; then
    VERSION_FLAG="--version $VERSION"
fi

build_a4() {
    echo "=== Building PDF A4 ==="
    python "$SCRIPTS/build_pdf.py" $INPUT -o "$OUTPUT/pdf-a4" --template "$TEMPLATES/book-a4.typ" $VERSION_FLAG
    typst compile --font-path "$FONTS" "$OUTPUT/pdf-a4/book.typ"
    echo "Done: $OUTPUT/pdf-a4/book.pdf"
}

build_a5() {
    echo "=== Building PDF A5 ==="
    python "$SCRIPTS/build_pdf.py" $INPUT -o "$OUTPUT/pdf-a5" --template "$TEMPLATES/book-a5.typ" $VERSION_FLAG
    typst compile --font-path "$FONTS" "$OUTPUT/pdf-a5/book.typ"
    echo "Done: $OUTPUT/pdf-a5/book.pdf"
}

build_epub() {
    echo "=== Building EPUB ==="
    python "$SCRIPTS/build_epub.py" $INPUT -o "$OUTPUT/epub/book.epub" $VERSION_FLAG
    echo "Done: $OUTPUT/epub/book.epub"
}

case "$TARGET" in
    a4)   build_a4 ;;
    a5)   build_a5 ;;
    epub) build_epub ;;
    all)  build_a4; build_a5; build_epub ;;
    *)    echo "Unknown target: $TARGET"; usage ;;
esac
